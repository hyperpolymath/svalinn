# SPDX-License-Identifier: PMPL-1.0-or-later
# ModSecurity Configuration for Svalinn Edge Gateway
# OWASP Core Rule Set (CRS) Integration

# ============================================================================
# Main Configuration
# ============================================================================

# Enable ModSecurity
SecRuleEngine On

# Request body inspection
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject

# Response body inspection
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml application/json
SecResponseBodyLimit 524288
SecResponseBodyLimitAction ProcessPartial

# Temporary directory
SecTmpDir /tmp/
SecDataDir /tmp/

# Upload directory
SecUploadDir /tmp/
SecUploadKeepFiles Off

# Debug log
SecDebugLog /var/log/svalinn/modsec_debug.log
SecDebugLogLevel 0

# Audit log
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/svalinn/modsec_audit.log

# ============================================================================
# OWASP CRS Custom Rules for Svalinn
# ============================================================================

# Rule ID range: 1000-1999 (custom Svalinn rules)

# ----------------------------------------------------------------------------
# SQL Injection Protection
# ----------------------------------------------------------------------------
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS|XML:/*|XML://@* \
  "@detectSQLi" \
  "id:1001,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,\
   msg:'SQL Injection Attack Detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   severity:CRITICAL,\
   tag:'OWASP_CRS/WEB_ATTACK/SQL_INJECTION',\
   tag:'application-multi',\
   tag:'language-multi',\
   tag:'platform-multi',\
   tag:'attack-sqli'"

# ----------------------------------------------------------------------------
# Cross-Site Scripting (XSS) Protection
# ----------------------------------------------------------------------------
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS|XML:/*|XML://@* \
  "@detectXSS" \
  "id:1002,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:htmlEntityDecode,t:lowercase,\
   msg:'XSS Attack Detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   severity:CRITICAL,\
   tag:'OWASP_CRS/WEB_ATTACK/XSS',\
   tag:'application-multi',\
   tag:'language-multi',\
   tag:'platform-multi',\
   tag:'attack-xss'"

# ----------------------------------------------------------------------------
# Server-Side Request Forgery (SSRF) Protection
# ----------------------------------------------------------------------------
SecRule ARGS|ARGS_NAMES "@rx ^https?://(localhost|127\\.0\\.0\\.1|::1|169\\.254\\.|192\\.168\\.|10\\.|172\\.(1[6-9]|2[0-9]|3[01])\\.|0\\.0\\.0\\.0|\\[::1\\]|\\[fe80:)" \
  "id:1003,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,t:lowercase,\
   msg:'SSRF Attack Detected - Internal IP in URL parameter',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   severity:CRITICAL,\
   tag:'OWASP_CRS/WEB_ATTACK/SSRF',\
   tag:'attack-ssrf'"

# ----------------------------------------------------------------------------
# Path Traversal Protection
# ----------------------------------------------------------------------------
SecRule ARGS|ARGS_NAMES|REQUEST_URI|REQUEST_BODY|REQUEST_COOKIES "@rx \\.\\./|\\.\\.\\\\" \
  "id:1004,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,\
   msg:'Path Traversal Attack Detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   severity:CRITICAL,\
   tag:'OWASP_CRS/WEB_ATTACK/PATH_TRAVERSAL',\
   tag:'attack-lfi'"

# ----------------------------------------------------------------------------
# Rate Limiting (100 requests per minute per IP)
# ----------------------------------------------------------------------------
SecAction \
  "id:1005,\
   phase:1,\
   nolog,\
   pass,\
   initcol:ip=%{REMOTE_ADDR},\
   setvar:ip.rate=+1,\
   expirevar:ip.rate=60"

SecRule IP:RATE "@gt 100" \
  "id:1006,\
   phase:2,\
   block,\
   msg:'Rate Limit Exceeded: %{IP:RATE} requests in 60 seconds',\
   logdata:'IP: %{REMOTE_ADDR}, Rate: %{IP:RATE}',\
   severity:WARNING,\
   tag:'application-multi',\
   tag:'platform-multi',\
   tag:'attack-dos'"

# ----------------------------------------------------------------------------
# Command Injection Protection
# ----------------------------------------------------------------------------
SecRule ARGS|ARGS_NAMES|REQUEST_BODY "@rx (?:;|\\||`|\\$\\(|\\$\\{)" \
  "id:1007,\
   phase:2,\
   block,\
   t:none,t:urlDecodeUni,\
   msg:'Command Injection Attack Detected',\
   logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
   severity:CRITICAL,\
   tag:'OWASP_CRS/WEB_ATTACK/COMMAND_INJECTION',\
   tag:'attack-rce'"

# ----------------------------------------------------------------------------
# Block Known Bad User-Agents
# ----------------------------------------------------------------------------
SecRule REQUEST_HEADERS:User-Agent "@rx (?i:sqlmap|nikto|nmap|masscan|metasploit|burp)" \
  "id:1008,\
   phase:1,\
   block,\
   msg:'Security Scanner Detected',\
   logdata:'User-Agent: %{MATCHED_VAR}',\
   severity:WARNING,\
   tag:'security-scanner'"

# ----------------------------------------------------------------------------
# Require Content-Type for POST/PUT requests
# ----------------------------------------------------------------------------
SecRule REQUEST_METHOD "@rx ^(?:POST|PUT)$" \
  "id:1009,\
   phase:1,\
   chain,\
   t:none,\
   block,\
   msg:'Missing Content-Type header for POST/PUT request'"
  SecRule &REQUEST_HEADERS:Content-Type "@eq 0" \
    "t:none"

# ----------------------------------------------------------------------------
# Validate Content-Type (only allow JSON for API)
# ----------------------------------------------------------------------------
SecRule REQUEST_METHOD "@rx ^(?:POST|PUT)$" \
  "id:1010,\
   phase:1,\
   chain,\
   t:none,\
   block,\
   msg:'Invalid Content-Type - only application/json allowed'"
  SecRule REQUEST_HEADERS:Content-Type "!@rx ^application/json" \
    "t:none,t:lowercase"

# ============================================================================
# OWASP CRS Integration Point
# ============================================================================

# Include OWASP CRS rules here when deploying to production
# Download from: https://github.com/coreruleset/coreruleset

# Include REQUEST-900-EXCLUSION-RULES-BEFORE-CRS.conf
# Include owasp-crs/*.conf
# Include RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf

# ============================================================================
# End of Configuration
# ============================================================================
