// SPDX-License-Identifier: PMPL-1.0-or-later
= Svalinn Edge Policy DSL
:toc: auto
:toclevels: 3

== Overview

The Svalinn Policy DSL defines security rules for container operations at the edge.
Inspired by Nickel's configuration language with a focus on security constraints.

== Policy Structure

[source,nickel]
----
{
  version = "1.0",
  name = "production-edge-policy",

  registries = {
    allow = ["docker.io", "ghcr.io", "quay.io", "gcr.io"],
    deny = [],
    require_signature = true,
  },

  images = {
    allow_patterns = ["*"],
    deny_patterns = ["*/test-*", "*/dev-*"],
    require_sbom = true,
    max_age_days = 90,
  },

  resources = {
    max_memory_mb = 4096,
    max_cpu_cores = 4.0,
    max_containers = 100,
  },

  security = {
    allow_privileged = false,
    allow_host_network = false,
    allow_host_pid = false,
    allow_host_ipc = false,
    read_only_root = true,
    drop_capabilities = ["ALL"],
    add_capabilities = ["NET_BIND_SERVICE"],
  },

  network = {
    allow_egress = true,
    allowed_ports = [80, 443, 8080],
    denied_hosts = ["*.internal", "10.0.0.0/8"],
  },
}
----

== Rule Types

=== Registry Rules

Control which container registries are allowed.

[cols="1,1,3"]
|===
| Field | Type | Description

| `allow` | `[string]` | List of allowed registry hostnames
| `deny` | `[string]` | List of denied registry hostnames (takes precedence)
| `require_signature` | `bool` | Require image signature verification
| `allowed_signers` | `[string]` | List of allowed signer fingerprints
|===

=== Image Rules

Control which container images are allowed.

[cols="1,1,3"]
|===
| Field | Type | Description

| `allow_patterns` | `[string]` | Glob patterns for allowed images
| `deny_patterns` | `[string]` | Glob patterns for denied images
| `require_sbom` | `bool` | Require SBOM attestation
| `max_age_days` | `int` | Maximum image age in days
| `max_vulnerabilities.critical` | `int` | Max critical vulnerabilities (default: 0)
| `max_vulnerabilities.high` | `int` | Max high vulnerabilities (default: 0)
|===

=== Resource Rules

Limit container resource usage.

[cols="1,1,3"]
|===
| Field | Type | Description

| `max_memory_mb` | `int` | Maximum memory per container
| `max_cpu_cores` | `float` | Maximum CPU cores per container
| `max_containers` | `int` | Maximum concurrent containers
| `max_storage_gb` | `int` | Maximum storage per container
|===

=== Security Rules

Container security constraints.

[cols="1,1,3"]
|===
| Field | Type | Description

| `allow_privileged` | `bool` | Allow privileged containers
| `allow_host_network` | `bool` | Allow host network namespace
| `allow_host_pid` | `bool` | Allow host PID namespace
| `allow_host_ipc` | `bool` | Allow host IPC namespace
| `read_only_root` | `bool` | Require read-only root filesystem
| `drop_capabilities` | `[string]` | Capabilities to drop
| `add_capabilities` | `[string]` | Capabilities to add
| `seccomp_profile` | `string` | Seccomp profile path
| `apparmor_profile` | `string` | AppArmor profile name
|===

=== Network Rules

Network access controls.

[cols="1,1,3"]
|===
| Field | Type | Description

| `allow_egress` | `bool` | Allow outbound connections
| `allow_ingress` | `bool` | Allow inbound connections
| `allowed_ports` | `[int]` | Allowed ports
| `denied_ports` | `[int]` | Denied ports
| `allowed_hosts` | `[string]` | Allowed egress hosts (glob)
| `denied_hosts` | `[string]` | Denied egress hosts (glob)
|===

== Evaluation Order

1. **Deny rules** are evaluated first (deny takes precedence)
2. **Allow rules** are evaluated second
3. If neither matches, **default deny** applies
4. **Resource limits** are always enforced

== Policy Composition

Policies can be composed using `extends`:

[source,nickel]
----
{
  extends = ["base-policy.ncl"],

  # Override specific rules
  security.allow_privileged = true,

  # Merge with base
  registries.allow = registries.allow @ ["internal.registry.local"],
}
----

== Built-in Policies

=== `strict` - Maximum security

* No privileged containers
* No host namespaces
* Read-only root
* Drop all capabilities
* Require signatures
* Require SBOM
* Zero critical/high vulnerabilities

=== `standard` - Balanced security

* No privileged containers
* No host namespaces
* Read-only root recommended
* Drop most capabilities
* Signatures optional

=== `permissive` - Development use only

* All restrictions relaxed
* For development environments only
* NOT for production

== JSON Representation

The policy DSL compiles to JSON for runtime evaluation:

[source,json]
----
{
  "version": "1.0",
  "name": "production-edge-policy",
  "rules": {
    "registries": {
      "allow": ["docker.io", "ghcr.io"],
      "deny": [],
      "requireSignature": true
    },
    "images": {
      "allowPatterns": ["*"],
      "denyPatterns": ["*/test-*"],
      "requireSbom": true
    },
    "resources": {
      "maxMemoryMb": 4096,
      "maxCpuCores": 4.0
    },
    "security": {
      "allowPrivileged": false,
      "readOnlyRoot": true
    }
  }
}
----
