// SPDX-License-Identifier: PMPL-1.0-or-later
= Svalinn Deployment Guide
:toc: preamble
:toclevels: 3
:icons: font

Complete guide for deploying Svalinn Gateway in production.

== Prerequisites

=== Runtime Requirements

* **Deno** >= 2.0
* **Vörðr** container runtime (must be accessible via MCP)
* **System:** Linux (Fedora, Ubuntu, Debian, etc.)

=== Build Requirements

* **ReScript** compiler (`npm install -g rescript` or use Deno)
* **Just** command runner (optional but recommended)

== Build from Source

=== 1. Clone Repository

[source,bash]
----
git clone https://github.com/hyperpolymath/svalinn.git
cd svalinn
----

=== 2. Install Dependencies

Deno automatically manages dependencies via `deno.json`. No separate install step needed.

=== 3. Compile ReScript

[source,bash]
----
# Using Just
just build-res

# Or manually
rescript build
----

This compiles `*.res` files to `*.res.js` in the same directory.

=== 4. Build Production Binary

[source,bash]
----
# Using Just
just build

# Or manually
deno compile \
  --allow-read \
  --allow-write \
  --allow-net \
  --allow-env \
  --output=dist/svalinn \
  src/main.ts
----

Output: `dist/svalinn` (standalone executable)

== Configuration

=== Environment Variables

[cols="1,2,1,2",options="header"]
|===
|Variable |Description |Required |Default

|`SVALINN_PORT`
|HTTP server port
|No
|`8000`

|`SVALINN_HOST`
|Bind address
|No
|`0.0.0.0`

|`VORDR_ENDPOINT`
|Vörðr MCP endpoint URL
|Yes
|`http://localhost:8080`

|`VORDR_TIMEOUT`
|MCP call timeout (ms)
|No
|`30000`

|`VORDR_RETRIES`
|MCP retry attempts
|No
|`3`

|`SPEC_VERSION`
|Spec version for validation
|No
|`v0.1.0`

|`AUTH_ENABLED`
|Enable authentication
|No
|`false`

|`AUTH_METHODS`
|Comma-separated: `oauth2,oidc,apikey,mtls`
|No
|`oauth2,oidc`

|`OIDC_ISSUER`
|OIDC issuer URL
|If using OIDC
|none

|`OIDC_CLIENT_ID`
|OIDC client ID
|If using OIDC
|none

|`OIDC_SCOPES`
|OIDC scopes (comma-separated)
|No
|`openid,profile,email`

|`API_KEYS`
|Valid API keys (comma-separated)
|If using API keys
|none
|===

=== Example Configuration

[source,bash]
----
# Minimal (development)
export SVALINN_PORT=8000
export VORDR_ENDPOINT=http://localhost:8080

# Production (with auth)
export SVALINN_PORT=8000
export SVALINN_HOST=0.0.0.0
export VORDR_ENDPOINT=http://vordr.internal:8080
export AUTH_ENABLED=true
export AUTH_METHODS=oidc,apikey
export OIDC_ISSUER=https://auth.example.com
export OIDC_CLIENT_ID=svalinn-prod
export API_KEYS=sk_prod_abc123,sk_prod_def456
----

== Deployment Options

=== Option 1: Systemd Service

Create `/etc/systemd/system/svalinn.service`:

[source,ini]
----
[Unit]
Description=Svalinn Edge Gateway
After=network.target vordr.service
Requires=vordr.service

[Service]
Type=simple
User=svalinn
Group=svalinn
WorkingDirectory=/opt/svalinn
ExecStart=/opt/svalinn/dist/svalinn
Restart=on-failure
RestartSec=5s

# Environment
Environment="SVALINN_PORT=8000"
Environment="VORDR_ENDPOINT=http://localhost:8080"
Environment="AUTH_ENABLED=true"

# Security
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/var/log/svalinn

[Install]
WantedBy=multi-user.target
----

Enable and start:

[source,bash]
----
sudo systemctl daemon-reload
sudo systemctl enable svalinn
sudo systemctl start svalinn
sudo systemctl status svalinn
----

=== Option 2: Docker Container

Create `Dockerfile`:

[source,dockerfile]
----
FROM denoland/deno:2.1.0

WORKDIR /app

# Copy source
COPY src/ ./src/
COPY spec/ ./spec/
COPY deno.json .
COPY rescript.json .

# Build
RUN deno cache src/main.ts

# Run
EXPOSE 8000
CMD ["deno", "run", "--allow-net", "--allow-env", "--allow-read", "src/main.ts"]
----

Build and run:

[source,bash]
----
docker build -t svalinn:latest .
docker run -d \
  -p 8000:8000 \
  -e VORDR_ENDPOINT=http://vordr:8080 \
  --name svalinn \
  svalinn:latest
----

=== Option 3: Standalone Binary

[source,bash]
----
# Copy binary to server
scp dist/svalinn user@server:/opt/svalinn/

# Copy schemas
scp -r spec/schemas user@server:/opt/svalinn/spec/

# Run directly
ssh user@server
cd /opt/svalinn
export VORDR_ENDPOINT=http://localhost:8080
./svalinn
----

== Reverse Proxy (Recommended)

=== Nginx Configuration

[source,nginx]
----
upstream svalinn {
    server 127.0.0.1:8000;
}

server {
    listen 443 ssl http2;
    server_name api.example.com;

    ssl_certificate /etc/ssl/certs/api.example.com.crt;
    ssl_certificate_key /etc/ssl/private/api.example.com.key;

    location / {
        proxy_pass http://svalinn;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Health check endpoint (no auth)
    location /health {
        proxy_pass http://svalinn;
        access_log off;
    }
}
----

== Health Checks

=== Endpoints

[cols="1,2,2",options="header"]
|===
|Endpoint |Purpose |Expected Response

|`/health`
|Basic health check
|`200 OK` with JSON status

|`/healthz`
|Kubernetes health
|`200 OK`

|`/ready`
|Readiness check (Vörðr connected)
|`200 OK` if Vörðr accessible, `503` otherwise

|`/readyz`
|Kubernetes readiness
|Same as `/ready`

|`/metrics`
|Prometheus metrics
|Text format metrics
|===

=== Monitoring Script

[source,bash]
----
#!/bin/bash
# Health check script for monitoring

ENDPOINT="http://localhost:8000/ready"
RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$ENDPOINT")

if [ "$RESPONSE" -eq 200 ]; then
  echo "✅ Svalinn healthy"
  exit 0
else
  echo "❌ Svalinn unhealthy (HTTP $RESPONSE)"
  exit 1
fi
----

== Performance Tuning

=== Deno Runtime Flags

[source,bash]
----
deno run \
  --allow-net \
  --allow-env \
  --allow-read \
  --v8-flags=--max-old-space-size=4096 \
  --unstable-worker-options \
  src/main.ts
----

=== OS Tuning

[source,bash]
----
# Increase file descriptor limit
ulimit -n 65536

# TCP tuning
sysctl -w net.core.somaxconn=4096
sysctl -w net.ipv4.tcp_max_syn_backlog=4096
----

== Security Hardening

=== 1. TLS/HTTPS Only

* Use reverse proxy (Nginx/Caddy) for TLS termination
* Redirect HTTP to HTTPS
* Use strong cipher suites

=== 2. Authentication

[source,bash]
----
# Production: Always enable auth
export AUTH_ENABLED=true
export AUTH_METHODS=oidc,apikey

# OIDC (recommended)
export OIDC_ISSUER=https://auth.example.com
export OIDC_CLIENT_ID=svalinn-prod

# API keys (for service accounts)
export API_KEYS=sk_prod_$(openssl rand -hex 32)
----

=== 3. Network Isolation

* Run Svalinn in private network
* Only expose via reverse proxy
* Firewall rules:
  - Allow: 443 (HTTPS) from internet
  - Allow: 8000 (Svalinn) from reverse proxy only
  - Allow: 8080 (Vörðr) from Svalinn only

=== 4. Principle of Least Privilege

[source,bash]
----
# Create dedicated user
sudo useradd -r -s /bin/false svalinn

# Restrict file permissions
sudo chown -R svalinn:svalinn /opt/svalinn
sudo chmod 700 /opt/svalinn
----

== Troubleshooting

=== Common Issues

[cols="1,2,2",options="header"]
|===
|Issue |Cause |Solution

|`503 Service Unavailable`
|Vörðr not reachable
|Check `VORDR_ENDPOINT`, ensure Vörðr is running

|`401 Unauthorized`
|Auth enabled, no token
|Provide valid JWT/API key in `Authorization` header

|`400 Bad Request`
|Invalid request format
|Check request against JSON schema

|`500 Internal Server Error`
|Runtime error
|Check logs, verify all environment variables set

|Slow responses
|Vörðr MCP timeout
|Increase `VORDR_TIMEOUT`, check network latency
|===

=== Debug Mode

[source,bash]
----
# Enable verbose logging (planned)
export LOG_LEVEL=debug

# Check Vörðr connectivity
curl http://localhost:8080/health
----

=== Logs

Svalinn uses structured JSON logging. Parse with `jq`:

[source,bash]
----
# View logs
journalctl -u svalinn -f | jq .

# Filter errors only
journalctl -u svalinn | jq 'select(.level == "error")'
----

== Backup and Recovery

=== What to Backup

* Configuration files (environment variables)
* TLS certificates
* API keys (securely stored)

=== What NOT to Backup

* Svalinn binary (rebuild from source)
* Container state (managed by Vörðr)

== Performance Benchmarks

Expected performance (hardware-dependent):

* Health endpoint: < 10ms latency
* Container list: < 100ms (depends on Vörðr)
* Request validation: < 5ms overhead
* Sustained load: 1000+ req/s

Run benchmarks:

[source,bash]
----
# Unit benchmarks
deno bench --allow-net benchmarks/gateway_bench.ts

# Load testing
deno run --allow-net benchmarks/load_test.ts
----

== Upgrading

=== From v0.1.x to v0.2.0

[source,bash]
----
# 1. Backup config
cp .env .env.backup

# 2. Pull latest
git pull origin main

# 3. Rebuild
just build

# 4. Restart
sudo systemctl restart svalinn
----

No breaking changes in v0.2.0.

== Support

* GitHub Issues: https://github.com/hyperpolymath/svalinn/issues
* Documentation: https://github.com/hyperpolymath/svalinn/tree/main/docs
* Security: See link:../SECURITY.md[SECURITY.md]
