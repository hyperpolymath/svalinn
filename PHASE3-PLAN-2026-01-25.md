# Phase 3: Full Stack Integration - Implementation Plan

**Created:** 2026-01-25
**Status:** Planning
**Timeline:** 6-8 weeks
**Goal:** Cerro Torre + Vörðr + Svalinn working end-to-end

---

## Executive Summary

Phase 3 integrates three production-ready components:
- **Cerro Torre** (Phase 0): 65% MVP - pack, verify, registry operations working
- **Vörðr** (Phase 1): 92% complete - runtime, eBPF monitoring, MCP server ready
- **Svalinn** (Phase 2): 95% complete - gateway, auth, MCP client, validation ready

**Critical Path:** Quick wins first (test existing integrations) → Add missing pieces (.ctp support) → Full workflow hardening

---

## Prerequisites Status

| Component | Status | Version | Blockers |
|-----------|--------|---------|----------|
| **Cerro Torre** | ✅ Ready | v0.1.0 | None (can pack/verify bundles) |
| **Vörðr** | ✅ Ready | v0.5.0-rc1 | None (MCP server working) |
| **Svalinn** | ✅ Ready | v0.2.0-rc1 | None (MCP client working) |

**All prerequisites met** - can begin Phase 3 immediately.

---

## Integration Points Analysis

### 1. Svalinn ↔ Vörðr (MCP Protocol)

**Status:** ✅ **Both sides implemented, needs E2E testing**

**Vörðr MCP Server** (`src/rust/mcp/server.rs`):
- 11 tool definitions (container_list, container_get, container_create, etc.)
- JSON-RPC 2.0 protocol
- Axum HTTP server on port 8080

**Svalinn MCP Client** (`src/mcp/McpClient.res`):
- JSON-RPC 2.0 client implementation
- Retry logic with exponential backoff
- Timeout handling (30s default)
- 6 container operations + 2 image operations

**Gap:** Never tested end-to-end with running instances

**Quick Win Tasks (Week 1):**
1. Start Vörðr MCP server locally
2. Start Svalinn gateway pointing to Vörðr
3. Test all 12 API endpoints → MCP calls
4. Verify error handling and retries
5. Load testing (target: 1000 req/s)

---

### 2. Cerro Torre → Vörðr (.ctp Bundle Loading)

**Status:** ⏳ **Format exists, runtime support missing**

**Cerro Torre .ctp Format:**
- Bundle structure: `bundle.tar.gz` with summary.json + layers/
- Signature verification working
- Transparency log integration (Rekor)
- Can pack Alpine images as .ctp bundles

**Vörðr Runtime:**
- Currently loads OCI images only
- Has `--runtime` flag (youki/runc)
- State management via SQLite

**Gap:** Vörðr doesn't have .ctp loader

**Implementation Tasks (Weeks 2-3):**
1. **Create `src/rust/runtime/ctp_loader.rs`**:
   - Parse summary.json
   - Extract layers from bundle
   - Verify signatures before loading
   - Convert to OCI config for youki/runc

2. **Add CLI command: `vordr run --ctp bundle.ctp`**:
   - Validate bundle format
   - Call ctp_loader
   - Launch container via existing runtime shim

3. **Integration with Gatekeeper (Ada/SPARK)**:
   - FFI call to verify signatures
   - Policy check before execution

4. **Tests**:
   - Pack Alpine with Cerro Torre
   - Run with Vörðr
   - Verify signature rejection on tampered bundles

---

### 3. Svalinn → Cerro Torre (.ctp Policy Validation)

**Status:** ✅ **Format validation implemented**

**Svalinn Policy Engine** (`src/policy/PolicyEngine.res`):
- Gatekeeper policy format parsing
- Attestation evaluation
- Predicate checking
- Signer verification

**Cerro Torre Provenance:**
- SLSA provenance generation (partial)
- In-toto attestation format (planned)
- Rekor transparency log integration

**Gap:** Full attestation format not wired end-to-end

**Implementation Tasks (Week 4):**
1. **Cerro Torre: Complete attestation generation**:
   - Finish `src/core/cerro_provenance.adb`
   - Generate SLSA provenance v1.0
   - Attach to .ctp bundles

2. **Svalinn: Wire attestation validation**:
   - Read provenance from .ctp upload
   - Validate against policy
   - Return 403 Forbidden if policy violation

3. **Integration test**:
   - Pack bundle with provenance
   - Upload to Svalinn
   - Test policy enforcement

---

## Phase 3 Timeline

### Week 1: Quick Wins - Test Existing Integrations

**Goal:** Validate Svalinn ↔ Vörðr MCP integration

**Tasks:**
1. ✅ Set up local testing environment
   - Start Vörðr MCP server (port 8080)
   - Start Svalinn gateway (port 3000)
   - Configure Svalinn → Vörðr endpoint

2. ✅ E2E API testing
   - Test all 12 REST endpoints
   - Verify MCP calls succeed
   - Test error scenarios (Vörðr down, timeout, etc.)

3. ✅ Performance validation
   - Run load tests (target: 1000 req/s)
   - Measure latency (<10ms health, <100ms container ops)
   - Identify bottlenecks

4. ✅ Documentation
   - Update TESTING.adoc with E2E scenarios
   - Document Svalinn ↔ Vörðr setup
   - Create troubleshooting guide

**Deliverable:** Working Svalinn + Vörðr integration tested and documented

---

### Weeks 2-3: .ctp Runtime Support in Vörðr

**Goal:** Enable `vordr run bundle.ctp` with signature verification

**Tasks:**

**Week 2: Core .ctp Loader**
1. Create `src/rust/runtime/ctp_loader.rs` (estimate: 300-400 lines)
   ```rust
   pub struct CtpBundle {
       summary: SummaryJson,
       layers: Vec<Layer>,
       signatures: Vec<Signature>,
   }

   impl CtpBundle {
       pub fn load(path: &Path) -> Result<Self> { ... }
       pub fn verify_signatures(&self) -> Result<bool> { ... }
       pub fn to_oci_config(&self) -> Result<OciConfig> { ... }
   }
   ```

2. Integrate with Ada Gatekeeper
   - FFI call to `verify_bundle` in Ada
   - Pass bundle path, get approval/rejection
   - Log decision to SQLite

3. Add CLI command
   ```bash
   vordr run --ctp bundle.ctp [--name mycontainer]
   vordr verify bundle.ctp  # Dry-run verification
   ```

**Week 3: Testing & Integration**
4. Write integration tests
   - Pack Alpine with Cerro Torre
   - Run with Vörðr
   - Test signature verification (reject tampered bundles)
   - Test policy enforcement

5. Update documentation
   - Add .ctp format docs to `docs/README.md`
   - CLI reference for `run --ctp`
   - Security model documentation

**Deliverable:** Vörðr can run verified .ctp bundles

---

### Week 4: Svalinn Policy Enforcement

**Goal:** Svalinn validates .ctp policies before accepting uploads

**Tasks:**

1. **Wire Cerro Torre provenance** (4-6 hours)
   - Complete `cerro_provenance.adb` SLSA generation
   - Attach provenance to bundles
   - Test with `ct pack --provenance`

2. **Svalinn attestation validation** (4-6 hours)
   - Read provenance from .ctp upload
   - Call PolicyEngine.evaluateAttestation
   - Return 403 if policy violation
   - Log validation decisions

3. **Integration test** (2-4 hours)
   - Upload valid bundle → accept
   - Upload unsigned bundle → reject (403)
   - Upload tampered bundle → reject (403)

4. **Documentation** (2 hours)
   - Policy format examples
   - Attestation validation flow
   - Security guarantees

**Deliverable:** Svalinn enforces .ctp policies

---

### Weeks 5-6: Security Hardening

**Goal:** Production-grade security for full stack

**Tasks:**

**Week 5: Security Features**
1. **SELinux policies** (8-12 hours)
   - Policy for Vörðr container runtime
   - Policy for Svalinn gateway
   - Policy for Cerro Torre builder
   - Test with enforcing mode

2. **AppArmor profiles** (6-8 hours)
   - Profile for vordr binary
   - Profile for svalinn binary
   - Test profile restrictions

3. **Seccomp filters** (6-8 hours)
   - Minimal syscall allowlist for containers
   - Runtime enforcement via youki
   - Test with real workloads

**Week 6: Security Audit**
4. **Full stack security audit** (12-16 hours)
   - Code review (all 3 components)
   - Dependency audit (cargo audit, deno vendor)
   - Penetration testing (container escape, privilege escalation)
   - Supply chain security (Sigstore, transparency logs)

5. **Threat model documentation**
   - Attack surface analysis
   - Trust boundaries
   - Security guarantees
   - Incident response procedures

**Deliverable:** Security audit report with 0 critical/high issues

---

### Weeks 7-8: Production Deployment

**Goal:** Deploy full stack to production

**Tasks:**

**Week 7: Deployment Infrastructure**
1. **Production deployment scripts** (8-12 hours)
   - Systemd units for Vörðr, Svalinn
   - Reverse proxy setup (nginx/Caddy)
   - TLS certificate automation (Let's Encrypt)
   - Monitoring (Prometheus, Grafana)

2. **Load testing at scale** (4-6 hours)
   - Simulate 1000+ req/s
   - Test concurrent container operations
   - Measure resource usage (CPU, RAM, disk I/O)
   - Identify scaling bottlenecks

3. **Failover and HA** (6-8 hours)
   - Multi-instance Svalinn (load balanced)
   - Shared state backend (PostgreSQL for Vörðr?)
   - Health checks and auto-restart

**Week 8: Documentation & Polish**
4. **Operator documentation** (8-12 hours)
   - Installation guide
   - Configuration reference
   - Troubleshooting guide
   - Backup and recovery procedures

5. **Performance optimization** (variable)
   - Profile hot paths
   - Optimize database queries (Vörðr SQLite)
   - Cache frequently accessed data
   - Tune eBPF monitoring overhead

6. **Final validation** (4-6 hours)
   - End-to-end workflow testing
   - Security audit review
   - Performance benchmarks
   - Documentation review

**Deliverable:** Production-ready full stack deployment

---

## Success Criteria

Phase 3 is complete when:

1. **End-to-End Workflow Functional:**
   ```bash
   # Pack with Cerro Torre
   ct pack alpine:latest -o app.ctp --sign

   # Upload to Svalinn (validates policy)
   curl -X POST http://localhost:3000/bundles/upload -F bundle=@app.ctp

   # Run with Vörðr (verifies signature)
   vordr run --ctp app.ctp --name myapp

   # Monitor with eBPF
   vordr monitor start --policy strict --container myapp
   ```

2. **Security Guarantees:**
   - ✅ Tampered bundles rejected (signature verification)
   - ✅ Unsigned bundles rejected (policy enforcement)
   - ✅ SELinux/AppArmor/Seccomp enabled
   - ✅ Security audit: 0 critical/high issues

3. **Performance Targets:**
   - ✅ Svalinn throughput: 1000+ req/s
   - ✅ Vörðr container start: <200ms
   - ✅ eBPF monitoring overhead: <1%
   - ✅ End-to-end latency: <500ms (pack → verify → run)

4. **Documentation:**
   - ✅ Operator guide complete
   - ✅ Security model documented
   - ✅ Troubleshooting guide
   - ✅ Architecture diagrams

---

## Integration Test Scenarios

### Scenario 1: Happy Path
```bash
# 1. Pack bundle
cd /tmp
ct pack alpine:latest -o alpine.ctp --sign

# 2. Upload to Svalinn
curl -X POST http://localhost:3000/bundles/upload \
  -H "Authorization: Bearer $TOKEN" \
  -F bundle=@alpine.ctp

# 3. Run with Vörðr (via Svalinn API)
curl -X POST http://localhost:3000/containers/create \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"bundle": "alpine.ctp", "name": "test"}'

# 4. Monitor
vordr monitor events --follow --container test

# 5. Stop
curl -X POST http://localhost:3000/containers/test/stop
```

**Expected:** All steps succeed, container runs securely

---

### Scenario 2: Tampered Bundle Rejection
```bash
# 1. Pack and sign
ct pack alpine:latest -o alpine.ctp --sign

# 2. Tamper with bundle
tar -xzf alpine.ctp
echo "malicious code" >> layers/layer0.tar.gz
tar -czf alpine-tampered.ctp summary.json layers/

# 3. Try to run
vordr run --ctp alpine-tampered.ctp --name evil

# Expected: REJECT - signature verification fails
```

**Expected:** Vörðr rejects bundle, logs security event

---

### Scenario 3: Policy Violation
```bash
# 1. Create bundle without required attestation
ct pack nginx:latest -o nginx.ctp  # No --sign

# 2. Upload to Svalinn
curl -X POST http://localhost:3000/bundles/upload \
  -F bundle=@nginx.ctp

# Expected: 403 Forbidden - policy requires signatures
```

**Expected:** Svalinn policy engine rejects upload

---

### Scenario 4: Load Testing
```bash
# Svalinn load test (target: 1000 req/s)
cd svalinn
just load-test

# Vörðr concurrent operations
for i in {1..100}; do
  vordr run --ctp test.ctp --name "app-$i" &
done
wait

# Check all containers started
vordr ps | wc -l  # Should be 100+
```

**Expected:** Meets performance targets, no errors

---

## Risk Mitigation

### High Risks

**Risk 1: .ctp format incompatibility**
- **Mitigation:** Validate with test bundles early (Week 2)
- **Fallback:** Extend grace period, support OCI fallback

**Risk 2: Signature verification performance**
- **Mitigation:** Profile early, cache verification results
- **Fallback:** Async verification queue

**Risk 3: Integration test failures**
- **Mitigation:** Mock interfaces for isolated testing
- **Fallback:** Fix one integration at a time

### Medium Risks

**Risk 4: SELinux policy complexity**
- **Mitigation:** Start with permissive mode, iterate
- **Fallback:** AppArmor as alternative

**Risk 5: Load testing reveals bottlenecks**
- **Mitigation:** Profile and optimize hot paths
- **Fallback:** Scale horizontally (multiple Svalinn instances)

---

## Dependencies

### External Services (for testing)
- **OIDC Provider:** Auth0 or Keycloak (Svalinn auth testing)
- **OCI Registry:** ghcr.io or Docker Hub (Cerro Torre testing)
- **Transparency Log:** Rekor public instance (Cerro Torre testing)

### System Requirements
- **Linux:** 5.x kernel (eBPF support)
- **Capabilities:** CAP_BPF, CAP_PERFMON (eBPF monitoring)
- **Runtime:** youki or runc installed
- **TLS:** Valid certificates for production

---

## Metrics & Tracking

### Weekly Progress Reports
Track in `PHASE3-PROGRESS-YYYY-MM-DD.md`:
- Tasks completed
- Blockers encountered
- Integration test results
- Performance benchmarks
- Security findings

### Final Report
At Phase 3 completion, generate:
- **PHASE3-COMPLETE-YYYY-MM-DD.md**:
  - All integration points validated
  - Security audit summary
  - Performance benchmarks
  - Known issues and workarounds
  - Recommendations for Phase 4

---

## Immediate Next Actions

### This Week (Week 1)
1. **Set up local testing environment** (today)
   - Start Vörðr MCP server on port 8080
   - Start Svalinn gateway on port 3000
   - Verify connectivity

2. **Run E2E tests** (tomorrow)
   - Test all 12 Svalinn API endpoints
   - Verify MCP calls to Vörðr
   - Document any issues

3. **Load testing** (day 3)
   - Run Svalinn load tests
   - Measure baseline performance
   - Identify optimization targets

4. **Documentation** (day 4-5)
   - Update TESTING.adoc with E2E scenarios
   - Document Svalinn ↔ Vörðr integration
   - Create troubleshooting guide

**Success Criteria for Week 1:**
- ✅ Svalinn + Vörðr integration working
- ✅ All 12 API endpoints tested
- ✅ Performance baseline established
- ✅ Documentation updated

---

## Files to Create/Modify

### Vörðr
- **NEW:** `src/rust/runtime/ctp_loader.rs` (~400 lines)
- **NEW:** `tests/ctp_integration.rs` (~200 lines)
- **MODIFY:** `src/rust/cli/run.rs` (add `--ctp` flag)
- **MODIFY:** `docs/README.md` (add .ctp format docs)
- **MODIFY:** `docs/CLI-REFERENCE.md` (add `run --ctp`)

### Svalinn
- **MODIFY:** `src/gateway/Gateway.res` (add bundle upload endpoint)
- **MODIFY:** `src/policy/PolicyEngine.res` (wire attestation validation)
- **NEW:** `tests/e2e_vordr_test.ts` (~300 lines)
- **MODIFY:** `TESTING.adoc` (add E2E scenarios)

### Cerro Torre
- **MODIFY:** `src/core/cerro_provenance.adb` (complete SLSA generation)
- **MODIFY:** `src/cli/cerro_cli.adb` (wire `--provenance` flag)
- **NEW:** `tests/e2e_full_stack.sh` (~200 lines)

### Cross-Cutting
- **NEW:** `docs/PHASE3-ARCHITECTURE.adoc` (integration architecture)
- **NEW:** `docs/SECURITY-MODEL.adoc` (full stack security)
- **NEW:** `docs/DEPLOYMENT.adoc` (production deployment guide)

---

## Conclusion

Phase 3 is achievable in 6-8 weeks with focused effort. The foundation is solid:
- Vörðr runtime is production-ready (92% complete)
- Svalinn gateway is production-ready (95% complete)
- Cerro Torre can pack/verify bundles (65% MVP)

**Critical Path:**
1. Week 1: Test existing integration (Svalinn ↔ Vörðr)
2. Weeks 2-3: Add .ctp support to Vörðr
3. Week 4: Wire policy enforcement
4. Weeks 5-6: Security hardening
5. Weeks 7-8: Production deployment

**Recommendation:** Begin Week 1 tasks immediately to validate assumptions and identify any hidden issues early.

---

**Plan Version:** 1.0
**Created:** 2026-01-25
**Owner:** Phase 3 Implementation Team
**Next Review:** After Week 1 completion
